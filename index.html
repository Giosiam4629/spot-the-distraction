<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>JW Fun & Games - Plagues Adventure</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap">
  <style>
    :root {
      --bg-color: #f0f7ff;
      --panel-bg: #ffffff;
      --primary-text: #3d5a80;
      --accent-green: #2a9d8f;
      --accent-red: #e76f51;
      --accent-orange: #f4a261;
      --font-header: 'Fredoka One', cursive;
      --font-body: 'Comic Neue', sans-serif;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    /* --- General Setup & Home Button --- */
    html, body {
        overscroll-behavior-y: contain;
    }
    body {
      font-family: var(--font-body);
      background-color: var(--bg-color);
      color: var(--primary-text);
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .main-container {
      width: 100%;
      max-width: 900px;
    }
    .panel {
      background-color: var(--panel-bg);
      border-radius: 20px;
      padding: 20px 30px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    h2, h3 {
      font-family: var(--font-header);
      color: var(--primary-text);
      margin-top: 0;
      text-align: center;
    }
    .screen { display: none; }
    .screen.active { display: block; }
    
    #home-reset-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background-color: var(--accent-orange);
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #home-reset-btn:hover {
      transform: scale(1.1);
      background-color: #e76f51;
    }
    .nav-button {
      margin: 10px 0;
      padding: 15px 25px;
      width: 100%;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-family: var(--font-header);
      font-size: 1.2rem;
      color: white;
      box-shadow: var(--shadow);
      display: block;
    }
    .instructions {
        text-align: center;
        margin-bottom: 15px;
        font-style: italic;
    }

    /* --- Main Menu --- */
    #main-menu-screen .panel { text-align: center; }
    #character-selector { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
    #character-selector input[type="radio"] { display: none; }
    #character-selector label { padding: 8px 15px; border-radius: 50px; cursor: pointer; font-weight: bold; background-color: #f0f0f0; transition: all 0.2s ease-in-out; }
    #character-selector input[type="radio"]:checked + label { background-color: var(--accent-orange); color: white; transform: scale(1.1); }
    #game-selection-buttons { margin-top: 20px; }
    
    /* --- Sorting Game --- */
    .sorting-header { display: flex; justify-content: space-between; font-family: var(--font-header); font-size: 1.2rem; margin-bottom: 15px; }
    .drop-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .dropzone { border: 3px dashed #ccc; min-height: 200px; padding: 10px; border-radius: 15px; transition: all 0.3s; }
    #makes-happy { background-color: #e8f5e9; }
    #distraction { background-color: #ffebee; }
    .dropzone.over { transform: scale(1.02); border-color: var(--accent-orange); }
    #cards-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 100px; padding: 20px 0; }
    .card { background-color: var(--panel-bg); border: 3px solid #ccc; padding: 15px; border-radius: 12px; cursor: grab; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 5px; box-shadow: var(--shadow); transition: transform 0.2s; width: 120px; }
    .card:hover { transform: translateY(-5px); }
    .card .emoji { font-size: 2rem; }

    /* --- Memory Game --- */
    .memory-header { display: flex; justify-content: space-around; font-family: var(--font-header); font-size: 1.2rem; margin-bottom: 15px; }
    #memory-game-grid { display: grid; gap: 10px; margin: 10px auto; max-width: 600px; }
    .memory-card { width: 100%; aspect-ratio: 1 / 1; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
    .memory-card.is-flipped { transform: rotateY(180deg); }
    .memory-card.is-matched { opacity: 0.5; pointer-events: none; }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; border-radius: 10px; }
    .card-front { background: white; border: 3px solid #ccc; transform: rotateY(180deg); font-size: 2.5rem; }
    .card-back { background: linear-gradient(135deg, #6a0dad, #9c27b0); font-size: 3rem; color: white; }
    @media (max-width: 600px) {
        .card-front { font-size: 1.8rem; }
        .card-back { font-size: 2.2rem; }
    }

    /* --- Platformer Game --- */
    #platformer-game-screen { text-align: center; }
    .platformer-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      margin-bottom: 15px;
      font-family: var(--font-header);
      font-size: clamp(0.9rem, 3vw, 1.2rem);
    }
    .platformer-stat .hearts {
      display: flex;
      align-items: center;
      gap: 5px; /* Space between hearts */
    }
    .heart-icon {
      width: 20px; height: 20px; position: relative;
      transform: rotate(-45deg); background-color: #ff4757;
      border-radius: 2px;
    }
    .heart-icon::before, .heart-icon::after {
      content: ''; width: 20px; height: 20px; position: absolute;
      border-radius: 50%; background-color: #ff4757;
    }
    .heart-icon::before { top: -10px; left: 0; }
    .heart-icon::after { top: 0; left: -10px; }
    
    #platformer-level-name { text-align: center; }
    #platformer-staff-status { text-align: right; }
    #platformer-canvas-container { 
        position: relative; 
        width: 100%;
        max-width: 800px;
        margin: auto;
        aspect-ratio: 16 / 9;
        background-color: #c1dff0;
        border-radius: 15px; 
        overflow: hidden; 
        box-shadow: var(--shadow); 
    }
    canvas#platformer-canvas { width: 100%; height: 100%; display: block; }
    #platformer-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-shadow: 2px 2px 4px #000; font-family: var(--font-header); background: rgba(0,0,0,0.5); z-index: 10; }
    #platformer-overlay h2 { font-size: clamp(2rem, 10vw, 3.5rem); margin-bottom: 20px; }
    #platformer-start-btn, #platformer-next-level-btn, #platformer-restart-btn { padding: 15px 30px; font-size: clamp(1rem, 5vw, 1.5rem); background-color: var(--accent-orange); color: white; border: none; border-radius: 15px; cursor: pointer; margin-top: 10px; }
    
    /* NEW: Touch Controls */
    #touch-controls {
        position: absolute;
        bottom: 15px;
        left: 0;
        right: 0;
        display: none;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        z-index: 5;
    }
    .touch-btn {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        color: white;
        font-size: 2rem;
        font-family: var(--font-header);
        display: flex;
        align-items: center;
        justify-content: center;
        -webkit-user-select: none; user-select: none;
    }
    @media (hover: none) and (pointer: coarse) {
        #touch-controls {
            display: flex;
        }
    }
  </style>
</head>
<body>

<button id="home-reset-btn" title="Go Home">üè†</button>

<div class="main-container">

  <div id="main-menu-screen" class="screen active">
    <div class="panel">
      <h2>Fun & Games!</h2>
      <p>Choose your character and pick a game to play.</p>
      <div id="character-selector">
        <input type="radio" id="char-boy" name="character" value="boy" checked><label for="char-boy">Boy üë¶</label>
        <input type="radio" id="char-girl" name="character" value="girl"><label for="char-girl">Girl üëß</label>
      </div>
      <div id="game-selection-buttons">
        <button id="start-sorting-btn" class="nav-button" style="background-color: var(--accent-green);">Sorting Challenge</button>
        <button id="start-memory-btn" class="nav-button" style="background-color: #9c27b0;">Memory Match</button>
        <button id="start-platformer-btn" class="nav-button" style="background-color: #2196F3;">Plagues Adventure</button>
      </div>
    </div>
  </div>
  <div id="sorting-game-screen" class="screen">
    <div class="panel">
        <div class="sorting-header">
            <span id="sorting-level-title">Sorting Challenge</span>
            <span>Level: <span id="sorting-level">1</span></span>
        </div>
        <p class="instructions">Drag each item to the correct box.</p>
        <div class="drop-container">
            <div id="makes-happy" class="dropzone"><h3>üëç Good Choice</h3></div>
            <div id="distraction" class="dropzone"><h3>ü§î Needs Caution</h3></div>
        </div>
        <div id="cards-container"></div>
    </div>
  </div>
  <div id="memory-game-screen" class="screen">
      <div class="panel">
          <h2>Memory Match</h2>
          <div class="memory-header">
              <span>Level: <span id="memory-level">1</span></span>
              <span>Matches: <span id="memory-matches">0 / 0</span></span>
          </div>
          <div id="memory-game-grid"></div>
      </div>
  </div>

  <div id="platformer-game-screen" class="screen">
    <div class="panel">
      <div class="platformer-header">
        <div class="platformer-stat"><div class="hearts" id="platformer-lives"></div></div>
        <div id="platformer-level-name" class="platformer-stat">Plague: N/A</div>
        <div id="platformer-staff-status" class="platformer-stat">Staff: READY</div>
      </div>
      <div id="platformer-canvas-container">
          <canvas id="platformer-canvas"></canvas>
          <div id="platformer-overlay">
              <h2 id="platformer-message"></h2>
              <button id="platformer-start-btn">Start Adventure üöÄ</button>
              <button id="platformer-next-level-btn" style="display:none;">Next Plague! ‚ú®</button>
              <button id="platformer-restart-btn" style="display:none;">Try Again</button>
          </div>
          <div id="touch-controls">
              <div style="display: flex; gap: 15px;">
                  <div id="touch-left" class="touch-btn">‚Äπ</div>
                  <div id="touch-right" class="touch-btn">‚Ä∫</div>
              </div>
              <div id="touch-jump" class="touch-btn">‚á°</div>
          </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- GLOBAL & MENU LOGIC ---
const initialGameState = { character: 'boy' };
let game = { ...initialGameState };
function switchScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); if (platformerGame.active) platformerGame.endGame(false, true); if (memoryGame.timerId) clearInterval(memoryGame.timerId); if (sortingGame.active) sortingGame.endGame(); }
function resetAndGoHome() { game = { ...initialGameState }; document.getElementById(`char-${game.character}`).checked = true; switchScreen('main-menu-screen'); }
document.getElementById('home-reset-btn').onclick = resetAndGoHome;

// --- 1. SORTING GAME (Unchanged) ---
const sortingGame = { active: false, level: 1, cardCount: 0, placedCount: 0, levels: [ { title: "General Actions", happy: [ { emoji: 'üôè', text: "Praying" }, { emoji: 'üßπ', text: "Chores" }, { emoji: 'üìñ', text: "Bible Reading" }, { emoji: 'ü§ó', text: "Sharing" } ], distraction: [ { emoji: 'üéÆ', text: "Too many games" }, { emoji: 'üò†', text: "Arguing" }, { emoji: 'üò´', text: "Complaining" }, { emoji: 'üì±', text: "Ignoring parents"} ] }, { title: "At the Kingdom Hall", happy: [ { emoji: 'üôã', text: "Commenting" }, { emoji: 'üé∂', text: "Singing" }, { emoji: 'ü§ù', text: "Greeting friends" }, { emoji: 'ü§´', text: "Listening quietly" } ], distraction: [ { emoji: 'üò¥', text: "Sleeping" }, { emoji: 'üèÉ', text: "Running around" }, { emoji: 'üí¨', text: "Talking loudly" }, { emoji: 'üñçÔ∏è', text: "Drawing on songbook"} ] }, { title: "Using Technology", happy: [ { emoji: 'üíª', text: "JW.ORG research" }, { emoji: 'üì±', text: "Texting a nice message" }, { emoji: 'üéß', text: "Listening to Kingdom songs" }, { emoji: 'ü§î', text: "Asking parents first" } ], distraction: [ { emoji: 'üëª', text: "Watching scary videos" }, { emoji: '‚è∞', text: "Staying up too late" }, { emoji: 'SECRET', text: "Secret accounts" }, { emoji: 'üò†', text: "Online arguments"} ] }, { title: "Choosing Friends", happy: [ { emoji: 'üòä', text: "Is kind" }, { emoji: 'üôè', text: "Loves Jehovah" }, { emoji: 'ü§ù', text: "Is helpful" }, { emoji: 'üëç', text: "Is honest" } ], distraction: [ { emoji: 'ü§¨', text: "Uses bad language" }, { emoji: 'üòè', text: "Makes fun of others" }, { emoji: 'ü§´', text: "Tells you to keep secrets" }, { emoji: 'üò†', text: "Is often angry"} ] } ], start(level = 1) { this.active = true; this.level = level; this.placedCount = 0; const currentLevel = this.levels[this.level - 1]; if(!currentLevel) { alert("Amazing! You've completed all the sorting challenges!"); resetAndGoHome(); return; } document.getElementById('sorting-level').textContent = this.level; document.getElementById('sorting-level-title').textContent = currentLevel.title; this.loadCards(); }, loadCards() { const cardContainer = document.getElementById('cards-container'); cardContainer.innerHTML = ''; document.getElementById('makes-happy').innerHTML = '<h3>üëç Good Choice</h3>'; document.getElementById('distraction').innerHTML = '<h3>ü§î Needs Caution</h3>'; const currentLevel = this.levels[this.level - 1]; const activities = [...currentLevel.happy, ...currentLevel.distraction]; activities.sort(() => 0.5 - Math.random()); this.cardCount = activities.length; activities.forEach((activity, idx) => { const card = document.createElement("div"); card.className = "card"; card.id = `card${idx}`; card.draggable = true; card.innerHTML = `<span class="emoji">${activity.emoji}</span><span>${activity.text}</span>`; const isHappy = currentLevel.happy.some(c => c.text === activity.text); card.dataset.correctZone = isHappy ? 'makes-happy' : 'distraction'; card.addEventListener('dragstart', (e) => e.dataTransfer.setData("text", e.target.id)); cardContainer.appendChild(card); }); document.querySelectorAll('.dropzone').forEach(zone => { zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('over'); }; zone.ondragleave = (e) => zone.classList.remove('over'); zone.ondrop = (e) => this.onDrop(e); }); }, onDrop(e) { e.preventDefault(); let dropzone = e.target; while (!dropzone.classList.contains('dropzone')) dropzone = dropzone.parentElement; dropzone.classList.remove('over'); const cardId = e.dataTransfer.getData("text"); const card = document.getElementById(cardId); if (card.dataset.correctZone === dropzone.id) { dropzone.appendChild(card); card.draggable = false; card.style.borderColor = 'var(--accent-green)'; this.placedCount++; if (this.placedCount === this.cardCount) { setTimeout(() => { this.start(this.level + 1); }, 1000); } } else { card.style.borderColor = 'var(--accent-red)'; setTimeout(() => card.style.borderColor = '#ccc', 500); } }, endGame() { this.active = false; } };

// --- 2. MEMORY GAME (Unchanged) ---
const memoryGame = { level: 1, timerId: null, matches: 0, goal: 0, isChecking: false, flippedCards: [], levelData: [ { pairs: 4, grid: '2x4' }, { pairs: 6, grid: '3x4' }, { pairs: 8, grid: '4x4' }, { pairs: 10, grid: '4x5' }, { pairs: 12, grid: '4x6' } ], start() { this.resetState(); const currentLevel = this.levelData[this.level - 1]; if (!currentLevel) { alert("Wow! You've completed all memory levels!"); resetAndGoHome(); return; } this.goal = currentLevel.pairs; this.updateUI(); this.createGrid(currentLevel.pairs, currentLevel.grid); }, createGrid(pairCount, gridLayout) { const grid = document.getElementById('memory-game-grid'); grid.innerHTML = ''; const [rows, cols] = gridLayout.split('x'); grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`; const cardEmojis = ['üôè','üìñ','ü§ù','üòä','üßπ','üé∂','ü§ó','‚ù§Ô∏è','üåü','üêë','ü¶Å','üïäÔ∏è']; let cardPool = cardEmojis.slice(0, pairCount); cardPool = [...cardPool, ...cardPool]; cardPool.sort(() => 0.5 - Math.random()); cardPool.forEach(emoji => { const cardEl = document.createElement('div'); cardEl.classList.add('memory-card'); cardEl.dataset.id = emoji; cardEl.innerHTML = `<div class="card-face card-back">?</div><div class="card-face card-front">${emoji}</div>`; cardEl.onclick = () => this.flipCard(cardEl); grid.appendChild(cardEl); }); }, flipCard(cardEl) { if (this.isChecking || cardEl.classList.contains('is-flipped') || this.flippedCards.length >= 2) return; cardEl.classList.add('is-flipped'); this.flippedCards.push(cardEl); if (this.flippedCards.length === 2) this.checkForMatch(); }, checkForMatch() { this.isChecking = true; const [card1, card2] = this.flippedCards; if (card1.dataset.id === card2.dataset.id) { this.matches++; this.updateUI(); setTimeout(() => { card1.classList.add('is-matched'); card2.classList.add('is-matched'); this.flippedCards = []; this.isChecking = false; if (this.matches === this.goal) this.levelComplete(); }, 500); } else { setTimeout(() => { card1.classList.remove('is-flipped'); card2.classList.remove('is-flipped'); this.flippedCards = []; this.isChecking = false; }, 1000); } }, levelComplete() { alert(`Level ${this.level} Complete!`); this.level++; this.start(); }, updateUI() { document.getElementById('memory-level').textContent = this.level; document.getElementById('memory-matches').textContent = `${this.matches} / ${this.goal}`; }, resetState() { this.matches = 0; this.isChecking = false; this.flippedCards = []; if (this.timerId) clearInterval(this.timerId); this.timerId = null; } };

// --- 3. PLATFORMER GAME (IMPROVED) ---
const platformerGame = {
    canvas: document.getElementById('platformer-canvas'),
    ctx: null, active: false, gameInterval: null, frame: 0,
    level: 1, lives: 3,
    player: { x: 100, y: 300, w: 40, h: 55, vx: 0, vy: 0, walkSpeed: 2.5, runSpeed: 4.5, jumpPower: 16, grounded: false, doubleJumpUsed: false, isSlowed: false, isInvincible: false, invincibleTimer: 0, animState: 'idle', animFrame: 0, facing: 'right', squash: 0, staff: { active: false, duration: 0, cooldown: 0, maxCooldown: 240 } },
    platforms: [], levelData: [], particles: [], goal: null,
    gravity: 0.7, camera: { x: 0 },
    
    levelDesigns: [ {},
        { name: "Nile to Blood", bgColor: ['#a02a2a', '#6b1c1c'], platformType: 'stone', parallax: [{img:'pyramid', num:2, speed:0.1}], layout: [ { x: 0, y: 400, w: 400 }, { x: 500, y: 320, w: 200 }, { x: 800, y: 250, w: 150 }, { x: 1100, y: 350, w: 250 }, { x: 1500, y: 280, w: 180 }, { x: 1800, y: 400, w: 300, goal: true} ] },
        { name: "Frogs", bgColor: ['#298c7a', '#1f6758'], platformType: 'lilypad', parallax: [{img:'reeds', num:5, speed:0.2}], layout: [ { x: 0, y: 400, w: 200 }, { x: 350, y: 350, w: 150 }, { x: 600, y: 400, w: 150 }, { x: 900, y: 320, w: 180 }, { x: 1250, y: 250, w: 120 }, { x: 1500, y: 380, w: 200}, { x: 1850, y: 300, w: 250, goal: true} ] },
        { name: "Gnats", bgColor: ['#d3b897', '#a98a65'], platformType: 'stone', parallax: [{img:'cloud', num:4, speed:0.3}], hasGnats: true, layout: [ { x: 0, y: 400, w: 300 }, { x: 450, y: 300, w: 200 }, { x: 750, y: 350, w: 150 }, { x: 1000, y: 280, w: 250 }, { x: 1400, y: 400, w: 400, goal: true} ] },
        { name: "Gadflies", bgColor: ['#87CEEB', '#bde0fe'], platformType: 'stone', parallax: [{img:'cloud', num:5, speed:0.4}], hasGadflies: true, layout: [ { x: 0, y: 400, w: 250 }, { x: 400, y: 300, w: 300 }, { x: 850, y: 400, w: 200 }, { x: 1200, y: 300, w: 200 }, { x: 1550, y: 400, w: 350, goal: true} ] },
        { name: "Livestock", bgColor: ['#bcaaa4', '#8d6e63'], platformType: 'wood', parallax: [{img:'cloud', num:3, speed:0.2}], hasSickGround: true, layout: [ { x: 0, y: 400, w: 200 }, { x: 300, y: 320, w: 150 }, { x: 550, y: 250, w: 200 }, { x: 900, y: 320, w: 150 }, { x: 1200, y: 400, w: 100 }, { x: 1450, y: 280, w: 250, goal: true} ] },
        { name: "Boils", bgColor: ['#616161', '#424242'], platformType: 'stone', parallax: [{img:'cloud', num:4, speed:0.1}], hasUnstable: true, layout: [ { x: 0, y: 400, w: 200 }, { x: 300, y: 350, w: 150, unstable: true }, { x: 550, y: 300, w: 150 }, { x: 800, y: 350, w: 150, unstable: true }, { x: 1100, y: 300, w: 150, unstable: true }, { x: 1400, y: 250, w: 200 }, { x: 1700, y: 400, w: 300, goal: true} ] },
        { name: "Hail", bgColor: ['#607D8B', '#455A64'], platformType: 'stone', parallax: [], hasHail: true, layout: [ { x: 0, y: 400, w: 350 }, { x: 500, y: 320, w: 100 }, { x: 750, y: 320, w: 100 }, { x: 1000, y: 400, w: 200 }, { x: 1350, y: 300, w: 150 }, { x: 1650, y: 400, w: 300, goal: true} ] },
        { name: "Locusts", bgColor: ['#ffc107', '#ffa000'], platformType: 'stone', parallax: [{img:'pyramid', num:1, speed:0.1}], hasLocusts: true, layout: [ { x: 0, y: 400, w: 300 }, { x: 450, y: 300, w: 250 }, { x: 850, y: 400, w: 250 }, { x: 1250, y: 300, w: 250 }, { x: 1650, y: 400, w: 300, goal: true} ] },
        { name: "Darkness", bgColor: ['#111', '#000'], platformType: 'stone', parallax: [], isDark: true, layout: [ { x: 0, y: 400, w: 150 }, { x: 300, y: 350, w: 150 }, { x: 600, y: 300, w: 150 }, { x: 900, y: 250, w: 150 }, { x: 1200, y: 350, w: 150 }, { x: 1500, y: 400, w: 200, goal: true} ] },
        { name: "Escape!", bgColor: ['#795548', '#4e342e'], platformType: 'crumble', parallax: [], isEscape: true, layout: [ { x: 0, y: 400, w: 300 }, { x: 400, y: 350, w: 200 }, { x: 700, y: 300, w: 150 }, { x: 950, y: 380, w: 250 }, { x: 1300, y: 320, w: 180 }, { x: 1600, y: 250, w: 150 }, { x: 1900, y: 400, w: 300, goal: true} ] },
    ],
    
    init() {
        this.ctx = this.canvas.getContext('2d');
        this.setCanvasSize();
        window.addEventListener('resize', () => this.setCanvasSize());
        this.ctx.fillStyle = '#c1dff0';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.updateUI();
        document.getElementById('platformer-start-btn').onclick = () => this.start(1);
        document.getElementById('platformer-next-level-btn').onclick = () => this.start(this.level + 1);
        document.getElementById('platformer-restart-btn').onclick = () => this.start(this.level);
        this.addTouchListeners();
        this.showOverlay("Plagues Adventure");
    },
    
    setCanvasSize() { this.canvas.width = 800; this.canvas.height = 450; },
    start(level) {
        let design = this.levelDesigns[level];
        if (level >= this.levelDesigns.length) { this.endGame(true); return; }
        if(!design || Object.keys(design).length === 0) { this.start(level + 1); return; }

        this.hideOverlay(); this.active = true; this.frame = 0; this.level = level;
        if(level === 1) { this.lives = 3; }
        this.player.x = 100; this.player.y = 300; this.player.vx = 0; this.player.vy = 0; this.player.staff.cooldown = 0; this.player.isInvincible = false;
        this.camera.x = 0; this.levelData = []; this.particles = [];
        this.generateLevel();
        if (this.gameInterval) clearInterval(this.gameInterval);
        this.gameInterval = setInterval(() => this.loop(), 1000 / 60);
        this.addKeyListeners();
    },
    keys: {}, touch: {left: false, right: false, jump: false},
    addKeyListeners() { this.keys = {}; const keydownHandler = e => { this.keys[e.code] = true; if(['Space','ArrowUp'].includes(e.code)) e.preventDefault(); }; const keyupHandler = e => this.keys[e.code] = false; window.addEventListener('keydown', keydownHandler); window.addEventListener('keyup', keyupHandler); this.removeListeners = () => { window.removeEventListener('keydown', keydownHandler); window.removeEventListener('keyup', keyupHandler); }; },
    addTouchListeners() { ['touchstart', 'touchend'].forEach(evt => { document.getElementById('touch-left').addEventListener(evt, e => { e.preventDefault(); this.touch.left = (evt === 'touchstart'); }); document.getElementById('touch-right').addEventListener(evt, e => { e.preventDefault(); this.touch.right = (evt === 'touchstart'); }); document.getElementById('touch-jump').addEventListener(evt, e => { e.preventDefault(); this.touch.jump = (evt === 'touchstart'); }); }); },
    
    generateLevel() { const design = this.levelDesigns[this.level]; this.platforms = design.layout.map(p => ({...p, h: (design.platformType === 'lilypad' ? 20 : 40), yOffset: 0 })); const goalPlatform = this.platforms.find(p => p.goal) || this.platforms[this.platforms.length - 1]; this.goal = {x: goalPlatform.x + goalPlatform.w / 2 - 25, y: goalPlatform.y - 50, w: 50, h: 50}; this.levelData = []; if(design.parallax) { design.parallax.forEach(p => { for(let i=0; i<p.num; i++) this.levelData.push({ type: 'parallax', img: p.img, x: Math.random() * goalPlatform.x * 2, y: Math.random() * this.canvas.height, speed: p.speed }) }); } if (design.hasGnats) { for(let i=0; i < 15; i++) { const plat = this.platforms[Math.floor(Math.random() * this.platforms.length)]; this.levelData.push({ type: 'gnatSwarm', x: plat.x + Math.random() * plat.w, y: plat.y - 60 - Math.random() * 50, w: 50, h: 40, active: true }); } } if (design.hasGadflies) { for(let i=0; i < 5; i++) { const plat = this.platforms[i % this.platforms.length]; this.levelData.push({ type: 'gadfly', x: plat.x, y: plat.y - 80, w: 25, h: 25, speed: 1.5 + Math.random(), originX: plat.x, range: plat.w }); } } if (design.hasHail) { for (let i=0; i < 50; i++) { this.levelData.push({ type: 'hail', x: Math.random() * goalPlatform.x + 200, y: -Math.random() * 3000, w: 10, h: 20, speed: 5 + Math.random() * 5 }); } } if (design.hasSickGround) { this.levelData.push({type: 'sickGround', x: 0, y: this.canvas.height - 20, w: goalPlatform.x + goalPlatform.w + 500, h: 20}) } if (design.hasLocusts) { for (let i = 0; i < 3; i++) { this.levelData.push({type: 'locustSwarm', y: 100 + i * 100, x: goalPlatform.x + 500 + i * 200, w: 150, h: 50, speed: -3 - Math.random() * 2 }) } } if (design.isEscape) { this.levelData.push({type: 'escapeWall', x: -300, w: 300, speed: 0.8}); } },
    loop() { if(!this.active) return; this.updatePlayerState(); this.updateWorld(); this.draw(); this.updateUI(); this.frame++; },
    updatePlayerState() { const p = this.player; if (p.squash > 0) p.squash = Math.max(0, p.squash - 0.1); if (p.staff.cooldown > 0) p.staff.cooldown--; if (p.staff.duration > 0) p.staff.duration--; else p.staff.active = false; if (p.invincibleTimer > 0) p.invincibleTimer--; else p.isInvincible = false; if (this.keys.KeyE && p.staff.cooldown <= 0) { p.staff.active = true; p.staff.duration = 30; p.staff.cooldown = p.staff.maxCooldown; } const moving = this.keys.KeyA || this.keys.ArrowLeft || this.keys.KeyD || this.keys.ArrowRight || this.touch.left || this.touch.right; let effectiveSpeed = this.keys.ShiftLeft ? p.runSpeed : p.walkSpeed; if (p.isSlowed) effectiveSpeed *= 0.5; if (this.keys.KeyA || this.keys.ArrowLeft || this.touch.left) { p.vx = -effectiveSpeed; p.facing = 'left'; } else if (this.keys.KeyD || this.keys.ArrowRight || this.touch.right) { p.vx = effectiveSpeed; p.facing = 'right'; } else { p.vx = 0; } const jumpPressed = this.keys.KeyW || this.keys.ArrowUp || this.keys.Space || this.touch.jump; if (jumpPressed) { if (p.grounded) { p.vy = -p.jumpPower; p.grounded = false; this.spawnParticles(p.x + p.w / 2, p.y + p.h, 10, '#f4a261', 'jump'); } else if (!p.doubleJumpUsed) { p.vy = -p.jumpPower * 0.8; p.doubleJumpUsed = true; this.spawnParticles(p.x + p.w / 2, p.y + p.h/2, 15, 'rgba(255,255,255,0.7)', 'doublejump'); } if(this.keys.KeyW) this.keys.KeyW = false; if(this.keys.ArrowUp) this.keys.ArrowUp = false; if(this.keys.Space) this.keys.Space = false; if(this.touch.jump) this.touch.jump = false; } p.vy += this.gravity; p.x += p.vx; if (p.y + p.h + p.vy > this.canvas.height && !design.hasSickGround) { p.y = this.canvas.height - p.h; p.vy = 0; this.land(); } else { p.y += p.vy; } let onPlatform = false; const design = this.levelDesigns[this.level]; if (design.hasUnstable) { this.platforms.forEach(plat => plat.yOffset = plat.unstable ? Math.sin(this.frame * 0.2 + plat.x) * 3 : 0); } this.platforms.forEach(plat => { if (this.checkCollision(p, {x: plat.x, y: plat.y + plat.yOffset, w: plat.w, h: 20}) && p.vy >= 0) { onPlatform = true; p.y = plat.y + plat.yOffset - p.h; p.vy = 0; this.land(); } }); if(!onPlatform) p.grounded = false; if (!p.grounded) p.animState = p.vy < 0 ? 'jump' : 'fall'; else if (moving) p.animState = this.keys.ShiftLeft ? 'run' : 'walk'; else p.animState = 'idle'; p.animFrame++; },
    land() { if (!this.player.grounded) { this.player.squash = 1; this.spawnParticles(this.player.x + this.player.w / 2, this.player.y + this.player.h, 15, '#a1887f', 'land'); } this.player.grounded = true; this.player.doubleJumpUsed = false; },
    updateWorld() { this.camera.x += (this.player.x - this.canvas.width / 3 - this.camera.x) * 0.1; this.particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life--; if (p.life <= 0) this.particles.splice(i, 1); }); this.player.isSlowed = false; this.levelData.forEach(item => { if (item.type === 'gnatSwarm' && item.active) { if (this.checkCollision(this.player, item)) this.player.isSlowed = true; if (this.player.staff.active && this.checkCollision({x: this.player.x-40, y:this.player.y-40, w:120, h:140}, item)) item.active = false; } if (item.type === 'gadfly' || item.type === 'hail' || item.type === 'sickGround' || item.type === 'locustSwarm' || item.type === 'escapeWall') { if (item.type === 'gadfly') { item.x += item.speed; if (item.x < item.originX || item.x > item.originX + item.range - item.w) item.speed *= -1; } if (item.type === 'hail') { item.y += item.speed; if (item.y > this.canvas.height) item.y = -Math.random() * 1000; } if (item.type === 'locustSwarm') { item.x += item.speed; if (item.x < -item.w) item.x = this.goal.x + 500; } if (item.type === 'escapeWall') { item.x += item.speed; } if (this.checkCollision(this.player, item)) this.loseLife(); } }); if (this.goal && this.checkCollision(this.player, this.goal)) { this.showOverlay(`Plague ${this.level} Cleared!`, true, false); this.endGame(false, true); } if (this.player.y > this.canvas.height + 50) this.loseLife(true); },
    loseLife(isFall = false) { if (this.player.isInvincible) return; this.lives--; this.player.isInvincible = true; this.player.invincibleTimer = 120; if (this.lives <= 0) { this.endGame(false); this.showOverlay("Game Over", false, true); } else { if (isFall) this.start(this.level); } },
    checkCollision(r1, r2) { return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y; },
    draw() { const design = this.levelDesigns[this.level]; if (!design) return; this.drawBackground(); this.ctx.save(); this.ctx.translate(-this.camera.x, 0); this.drawParallax(); this.drawPlatforms(); this.drawLevelEntities(); this.drawGoal(); this.particles.forEach(p => { this.ctx.fillStyle = p.color; this.ctx.globalAlpha = p.life / p.maxLife; this.ctx.beginPath(); this.ctx.arc(p.x,p.y,p.r,0,Math.PI*2); this.ctx.fill(); this.ctx.globalAlpha = 1; }); this.drawPlayer(); this.ctx.restore(); if (design.isDark) this.drawDarkness(); },
    drawParallax() { this.levelData.filter(d=>d.type === 'parallax').forEach(item => { const x = item.x - this.camera.x * item.speed; const y = item.y; if(item.img === 'cloud') { this.ctx.fillStyle = 'rgba(255,255,255,0.7)'; this.ctx.beginPath(); this.ctx.ellipse(x, y, 80, 25, 0, 0, Math.PI*2); this.ctx.ellipse(x+40, y-10, 90, 30, 0, 0, Math.PI*2); this.ctx.fill(); } if(item.img === 'pyramid') { this.ctx.fillStyle = '#c8a365'; this.ctx.beginPath(); this.ctx.moveTo(x, y); this.ctx.lineTo(x+100, y); this.ctx.lineTo(x+50, y-80); this.ctx.closePath(); this.ctx.fill(); } if(item.img === 'reeds') { this.ctx.strokeStyle = '#2e7d32'; this.ctx.lineWidth = 4; for(let i = 0; i<3; i++) { this.ctx.beginPath(); this.ctx.moveTo(x+i*10, y); this.ctx.lineTo(x+i*10, y-50); this.ctx.stroke(); } } });},
    drawLevelEntities() { this.levelData.forEach(item => { if (item.type === 'gnatSwarm' && item.active) { this.ctx.fillStyle = 'rgba(50,50,50,0.5)'; this.ctx.beginPath(); this.ctx.ellipse(item.x + item.w/2, item.y + item.h/2 + Math.sin(this.frame*0.2)*5, item.w/2, item.h/2, 0, 0, Math.PI*2); this.ctx.fill(); } if (item.type === 'gadfly') { this.ctx.fillStyle = 'black'; this.ctx.beginPath(); this.ctx.ellipse(item.x + item.w/2, item.y + item.h/2, item.w/1.5, item.h/2, 0, 0, Math.PI*2); this.ctx.fill(); this.ctx.fillStyle = 'white'; this.ctx.beginPath(); this.ctx.ellipse(item.x + item.w/2, item.y + item.h/2, item.w/1.5, item.h/2, -Math.PI/4, 0, Math.PI); this.ctx.fill(); } if (item.type === 'hail') { const grad = this.ctx.createLinearGradient(item.x, item.y, item.x, item.y+item.h); grad.addColorStop(0, '#ffffff'); grad.addColorStop(1, '#e0e0e0'); this.ctx.fillStyle = grad; this.ctx.fillRect(item.x, item.y, item.w, item.h); } if (item.type === 'sickGround') { this.ctx.fillStyle = 'rgba(76, 175, 80, 0.5)'; this.ctx.fillRect(item.x, item.y, item.w, item.h); } if (item.type === 'locustSwarm') { for(let i=0; i<5; i++){ this.ctx.fillStyle='green'; this.ctx.fillRect(item.x+Math.random()*item.w, item.y+Math.random()*item.h, 5, 5); } } if (item.type === 'escapeWall') { this.ctx.fillStyle = '#c62828'; this.ctx.fillRect(item.x, 0, item.w, this.canvas.height);} }); },
    drawDarkness() { this.ctx.save(); this.ctx.fillStyle = '#000'; this.ctx.fillRect(0,0, this.canvas.width, this.canvas.height); const p_center_x = this.player.x + this.player.w/2 - this.camera.x; const p_center_y = this.player.y + this.player.h/2; const lightRadius = 120; const grad = this.ctx.createRadialGradient(p_center_x, p_center_y, 0, p_center_x, p_center_y, lightRadius); grad.addColorStop(0, 'rgba(0,0,0,1)'); grad.addColorStop(0.8, 'rgba(0,0,0,1)'); grad.addColorStop(1, 'rgba(0,0,0,0)'); this.ctx.globalCompositeOperation = 'destination-out'; this.ctx.fillStyle = grad; this.ctx.beginPath(); this.ctx.arc(p_center_x, p_center_y, lightRadius, 0, Math.PI*2); this.ctx.fill(); this.ctx.restore(); },
    drawPlayer() { const p = this.player; const art = game.character === 'boy' ? {tunic1:'#4a90e2', tunic2:'#3b73b5', skin1:'#f2a66e', skin2:'#d88c57', hair1:'#3a2d27', hair2:'#2a1d17'} : {tunic1:'#e91e63', tunic2:'#c2185b', skin1:'#ffbe87', skin2:'#e5a36f', hair1:'#8b572a', hair2:'#6d4c41'}; let squashY = 1 - Math.sin(p.squash * Math.PI) * 0.2; let stretchX = 1 + Math.sin(p.squash * Math.PI) * 0.2; this.ctx.save(); if (p.isInvincible && this.frame % 10 < 5) this.ctx.globalAlpha = 0.5; this.ctx.translate(p.x + p.w / 2, p.y + p.h); if (p.facing === 'left') this.ctx.scale(-1, 1); this.ctx.scale(stretchX, squashY); this.ctx.translate(-(p.x + p.w / 2), -(p.y + p.h)); const bob = (p.animState === 'walk' || p.animState === 'run') ? Math.sin(p.animFrame * (p.animState === 'run' ? 0.5 : 0.3)) : 0; const legSwing = (p.animState === 'walk' || p.animState === 'run') ? Math.sin(p.animFrame * (p.animState === 'run' ? 0.5 : 0.3)) * 30 : 0; const headY = p.y+15+bob*2, bodyY = p.y+35+bob, legY = p.y+50+bob; this.ctx.fillStyle=art.tunic2; this.ctx.fillRect(p.x+8, bodyY-2, 24, 20); this.ctx.fillStyle=art.skin2; this.ctx.fillRect(p.x+5, legY, 10, 10); this.ctx.fillRect(p.x+25, legY, 10, 10); this.ctx.save(); this.ctx.translate(p.x+10, legY); this.ctx.rotate(legSwing * Math.PI / 180); this.ctx.fillRect(-5, 0, 10, 10); this.ctx.restore(); this.ctx.save(); this.ctx.translate(p.x+30, legY); this.ctx.rotate(-legSwing * Math.PI / 180); this.ctx.fillRect(-5, 0, 10, 10); this.ctx.restore(); this.ctx.fillStyle=art.tunic1; this.ctx.fillRect(p.x+10, bodyY, 20, 20); this.ctx.fillStyle=art.skin1; this.ctx.beginPath();this.ctx.arc(p.x+p.w/2, headY, 12, 0, Math.PI*2);this.ctx.fill();this.ctx.fillStyle=art.hair2;this.ctx.beginPath();this.ctx.arc(p.x+p.w/2, headY-4, 12, 0, Math.PI*2);this.ctx.fill();this.ctx.fillStyle=art.hair1;this.ctx.beginPath();this.ctx.arc(p.x+p.w/2, headY-5, 12, 0, Math.PI*2);this.ctx.fill();this.ctx.fillStyle='white';this.ctx.beginPath();this.ctx.ellipse(p.x+p.w/2+5, headY, 4, 5, 0, 0, Math.PI*2);this.ctx.fill();this.ctx.fillStyle='black';this.ctx.beginPath();this.ctx.arc(p.x+p.w/2+6, headY+1, 2, 0, Math.PI*2);this.ctx.fill(); this.ctx.restore(); if (p.staff.active) { this.ctx.save(); this.ctx.strokeStyle = `rgba(255, 255, 100, ${0.5 + (p.staff.duration/60)})`; this.ctx.lineWidth = 10; this.ctx.beginPath(); const radius = 40 + (30-p.staff.duration)*2; this.ctx.arc(p.x + p.w/2, p.y + p.h/2, radius, 0, Math.PI * 2); this.ctx.stroke(); this.ctx.restore(); } },
    endGame(isWin = false, isSoftEnd = false) { this.active = false; clearInterval(this.gameInterval); if (this.removeListeners) this.removeListeners(); if (isSoftEnd) return; if (isWin) this.showOverlay("You cleared all the plagues!", false, true); else this.showOverlay("Game Over", false, true); },
    
    updateUI() { const design = this.levelDesigns[this.level] || {}; document.getElementById('platformer-level-name').textContent = `Plague: ${this.level || 'N/A'}. ${design.name || ''}`; const livesContainer = document.getElementById('platformer-lives'); livesContainer.innerHTML = ''; for(let i=0; i<this.lives; i++) { const heart = document.createElement('div'); heart.className = 'heart-icon'; livesContainer.appendChild(heart); } const staffCooldown = this.player.staff.cooldown; const staffStatusEl = document.getElementById('platformer-staff-status'); if (staffCooldown > 0) { const percentage = Math.floor(100 - (staffCooldown / this.player.staff.maxCooldown) * 100); staffStatusEl.textContent = `Staff: ${percentage}%`; } else { staffStatusEl.textContent = "Staff: READY (E)"; } },
    spawnParticles(x, y, count, color, type) { for (let i = 0; i < count; i++) { let vx, vy, life, r; if(type==='land'){ vx=(Math.random()-0.5)*3; vy=-Math.random()*3; life=20; r=Math.random()*2+1; } else if(type==='doublejump'){ vx=(Math.random()-0.5)*4; vy=(Math.random()-0.5)*4; life=30; r=Math.random()*2+2; } else { vx=(Math.random()-0.5)*5; vy=(Math.random()-0.5)*5-1; life=40; r=Math.random()*3+1; } this.particles.push({ x, y, vx, vy, life, maxLife: life, color, r }); } },
    drawBackground() { const design = this.levelDesigns[this.level]; if (!design) return; const grad = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height); grad.addColorStop(0, design.bgColor[0]); grad.addColorStop(1, design.bgColor[1]); this.ctx.fillStyle = grad; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); },
    drawPlatforms() { const design = this.levelDesigns[this.level]; if (!design) return; this.platforms.forEach(p => { const y = p.y + p.yOffset; if(design.platformType === 'stone' || design.platformType === 'crumble' || design.platformType === 'wood') { const topC = design.platformType === 'stone' ? '#a1887f' : (design.platformType === 'wood' ? '#a1887f' : '#bcaaa4'); const botC = design.platformType === 'stone' ? '#8d6e63' : (design.platformType === 'wood' ? '#8d6e63' : '#a1887f'); const grad = this.ctx.createLinearGradient(p.x, y, p.x, y+p.h); grad.addColorStop(0, topC); grad.addColorStop(1, botC); this.ctx.fillStyle = grad; this.ctx.fillRect(p.x, y, p.w, p.h); this.ctx.fillStyle='rgba(0,0,0,0.2)'; this.ctx.fillRect(p.x, y+p.h-5, p.w, 5); } else if (design.platformType === 'lilypad') { this.ctx.fillStyle = '#4caf50'; this.ctx.beginPath(); this.ctx.ellipse(p.x + p.w / 2, y + p.h / 2, p.w / 2, p.h * 0.8, 0, 0, Math.PI * 2); this.ctx.fill(); this.ctx.fillStyle = '#66bb6a'; this.ctx.beginPath(); this.ctx.ellipse(p.x + p.w / 2, y + p.h / 2 - 2, p.w / 2 * 0.8, p.h * 0.7, 0, 0, Math.PI * 2); this.ctx.fill(); } }); },
    drawGoal() { if (!this.goal) return; this.ctx.save(); this.ctx.globalAlpha = 0.5 + Math.sin(this.frame * 0.05) * 0.5; const grad = this.ctx.createRadialGradient(this.goal.x+this.goal.w/2, this.goal.y+this.goal.h/2, 0, this.goal.x+this.goal.w/2, this.goal.y+this.goal.h/2, this.goal.w); grad.addColorStop(0, 'rgba(255, 215, 0, 0.8)'); grad.addColorStop(1, 'rgba(244, 162, 97, 0)'); this.ctx.fillStyle = grad; this.ctx.fillRect(this.goal.x-this.goal.w/2, this.goal.y-this.goal.h/2, this.goal.w*2, this.goal.h*2); this.ctx.restore(); this.ctx.fillStyle = 'white'; this.ctx.font = '32px Fredoka One'; this.ctx.textAlign='center'; this.ctx.fillText("üèÅ", this.goal.x + this.goal.w/2, this.goal.y + this.goal.h-10); },
    showOverlay(message, showNext = false, showRestart = false) { const overlay = document.getElementById('platformer-overlay'); document.getElementById('platformer-message').textContent = message; document.getElementById('platformer-start-btn').style.display = (!showNext && !showRestart) ? 'inline-block' : 'none'; document.getElementById('platformer-next-level-btn').style.display = showNext ? 'inline-block' : 'none'; document.getElementById('platformer-restart-btn').style.display = showRestart ? 'inline-block' : 'none'; overlay.style.display = 'flex'; },
    hideOverlay() { document.getElementById('platformer-overlay').style.display = 'none'; }
};

// --- INITIALIZATION & EVENT LISTENERS ---
window.onload = () => {
    document.getElementById('start-sorting-btn').onclick = () => { switchScreen('sorting-game-screen'); sortingGame.start(); };
    document.getElementById('start-memory-btn').onclick = () => { switchScreen('memory-game-screen'); memoryGame.level = 1; memoryGame.start(); };
    document.getElementById('start-platformer-btn').onclick = () => { switchScreen('platformer-game-screen'); platformerGame.init(); };
    document.getElementById('character-selector').onchange = (e) => { game.character = e.target.value; };
};
</script>
</body>
</html>

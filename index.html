<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spot the Distraction - Adventure Edition</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap">
  <style>
    :root {
      --bg-color: #eaf5ff;
      --panel-bg: #ffffff;
      --primary-text: #3d5a80;
      --accent-green: #2a9d8f;
      --accent-red: #e76f51;
      --accent-orange: #f4a261;
      --font-header: 'Fredoka One', cursive;
      --font-body: 'Comic Neue', sans-serif;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    /* --- General Setup --- */
    body {
      font-family: var(--font-body);
      background-color: var(--bg-color);
      color: var(--primary-text);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .main-container {
      width: 100%;
      max-width: 900px;
    }
    .panel {
      background-color: var(--panel-bg);
      border-radius: 20px;
      padding: 20px 30px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    h2, h3 {
      font-family: var(--font-header);
      color: var(--primary-text);
      margin-top: 0;
    }

    /* --- Screens --- */
    .screen { display: none; }
    .screen.active { display: block; }
    
    /* --- NEW: Home/Reset Button --- */
    #home-reset-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background-color: var(--accent-orange);
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #home-reset-btn:hover {
      transform: scale(1.1);
      background-color: #e76f51;
    }

    /* --- Game Controls Panel --- */
    #game-controls h2 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .control-section {
      margin-bottom: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .options-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .options-group input[type="radio"] { display: none; }
    .options-group label {
      padding: 8px 15px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .options-group input[type="radio"]:checked + label {
      background-color: var(--accent-orange);
      color: white;
      transform: scale(1.1);
    }
    #game-progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    #game-progress-fill {
      width: 0%;
      height: 100%;
      background-color: var(--accent-green);
      transition: width 0.5s ease;
    }
    .stats-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .stat-box {
      background-color: #f7f9fc;
      border-radius: 10px;
      padding: 10px 20px;
      font-family: var(--font-header);
      font-size: 1.2rem;
      min-width: 100px;
      text-align: center;
    }
    
    /* --- Sorting Game --- */
    .drop-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .dropzone {
      border: 3px dashed #ccc;
      min-height: 200px;
      padding: 15px;
      border-radius: 15px;
      transition: all 0.3s;
    }
    #closer { background-color: #e8f5e9; }
    #distraction { background-color: #ffebee; }
    .dropzone.over { transform: scale(1.02); border-color: var(--accent-orange); }
    #cards-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      min-height: 150px;
      padding: 20px 0;
    }
    .card {
      background-color: var(--panel-bg);
      border: 3px solid;
      padding: 15px;
      border-radius: 12px;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-5px); }
    .card .emoji { font-size: 2rem; }

    /* --- Minigame Screen --- */
    #minigame-screen { text-align: center; }
    .minigame-header {
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
    }
    .minigame-stat { font-family: var(--font-header); font-size: 1.2rem; }
    .minigame-stat .hearts { font-size: 1.8rem; letter-spacing: 2px; }
    canvas#minigame-canvas {
      background: linear-gradient(#87CEEB, #90EE90);
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin: 20px 0;
      width: 100%;
      image-rendering: pixelated; /* Crucial for pixelated look */
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    #minigame-start-btn {
      padding: 15px 30px;
      font-size: 1.5rem;
      background-color: var(--accent-orange);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
    }
    #minigame-instructions { margin-top: 15px; font-style: italic; }

    /* Buttons */
    .nav-button {
        margin-top: 20px;
        background-color: #6a0dad;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-family: var(--font-header);
    }
  </style>
</head>
<body>

<button id="home-reset-btn" title="Reset Game and Go Home">üè†</button>

<div class="main-container">

  <div id="sorting-game-screen" class="screen active">
    <div id="game-controls" class="panel">
      <div class="control-section">
        <h2>üë§ Choose Your Character</h2>
        <div class="options-group" id="character-selector">
          <input type="radio" id="char-cello" name="character" value="cello" checked><label for="char-cello">Cello (7-yr) üë¶</label>
          <input type="radio" id="char-fina" name="character" value="fina"><label for="char-fina">Fina (11-yr) üëß</label>
          <input type="radio" id="char-teen" name="character" value="teen"><label for="char-teen">Teen (15-yr) üë©‚Äçüéì</label>
          <input type="radio" id="char-adult" name="character" value="adult"><label for="char-adult">Adult üë®‚Äçüë©‚Äçüëß‚Äçüë¶</label>
        </div>
      </div>
      <div class="control-section">
        <h2>‚ö° Difficulty Level</h2>
        <div class="options-group" id="difficulty-selector">
          <input type="radio" id="diff-easy" name="difficulty" value="easy" checked><label for="diff-easy">Easy (No Timer) üòä</label>
          <input type="radio" id="diff-medium" name="difficulty" value="medium"><label for="diff-medium">Medium (2 min timer) ‚è∞</label>
          <input type="radio" id="diff-hard" name="difficulty" value="hard"><label for="diff-hard">Hard (1 min timer) üî•</label>
        </div>
      </div>
      <div class="control-section">
        <h2>üìä Game Progress</h2>
        <p>Level: <span id="level-label">1</span> / 5</p>
        <div id="game-progress-bar"><div id="game-progress-fill"></div></div>
      </div>
      <div class="stats-container">
        <div class="stat-box">Score: <span id="score-label">0</span></div>
        <div class="stat-box">Streak: <span id="streak-label">0</span></div>
        <div class="stat-box">Time: <span id="timer-label">--:--</span></div>
      </div>
    </div>
    
    <div class="panel">
      <div class="drop-container">
        <div id="closer" class="dropzone"><h3>üëç Keeps Me Close to Jehovah</h3></div>
        <div id="distraction" class="dropzone"><h3>ü§î Could Be a Distraction</h3></div>
      </div>
      <h3 style="text-align: center;">Drag the Activities</h3>
      <div id="cards-container"></div>
    </div>
    <div style="text-align:center;">
        <button id="switch-to-minigame-btn" class="nav-button">üéÆ Play Side-Scroller Adventure!</button>
    </div>
  </div>

  <div id="minigame-screen" class="screen">
    <div class="panel">
      <h2>üéÆ Advanced Mini-Game: Side-Scroller Adventure!</h2>
      <div class="minigame-header">
        <div class="minigame-stat">Adventure Score: <span id="minigame-score">0</span></div>
        <div class="minigame-stat">Kingdom Tokens: <span id="minigame-tokens">0</span> / 10</div>
        <div class="minigame-stat"><span class="hearts" id="minigame-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
      </div>
      <canvas id="minigame-canvas" width="600" height="300"></canvas>
      <button id="minigame-start-btn">Start Adventure üöÄ</button>
      <div id="minigame-instructions">Use SPACE or ‚Üë to jump. Collect Kingdom Tokens üìñ! Avoid distractions üì∫!</div>
      <button id="switch-to-sorting-btn" class="nav-button" style="background-color:#777;">Back to Sorting Game</button>
    </div>
  </div>

</div>

<script>
// --- GAME STATE ---
const initialGameState = {
    character: 'cello',
    difficulty: 'easy',
    level: 1,
    maxLevels: 5,
    score: 0,
    streak: 0,
    timerId: null,
    timeLeft: 0,
    activeScreen: 'sorting'
};
let game = { ...initialGameState };

// --- DOM ELEMENTS ---
const elements = {
    sortingScreen: document.getElementById('sorting-game-screen'),
    minigameScreen: document.getElementById('minigame-screen'),
    characterSelector: document.getElementById('character-selector'),
    difficultySelector: document.getElementById('difficulty-selector'),
    levelLabel: document.getElementById('level-label'),
    progressFill: document.getElementById('game-progress-fill'),
    scoreLabel: document.getElementById('score-label'),
    streakLabel: document.getElementById('streak-label'),
    timerLabel: document.getElementById('timer-label'),
    cardsContainer: document.getElementById('cards-container')
};

// --- "64-BIT" STYLE ANIMATED PIXEL ART ---
const pixelArt = {
    // A helper to draw a grid of pixels from a color map
    drawFromMap(ctx, x, y, map, size) {
        map.pixels.forEach((row, r) => {
            row.forEach((colorKey, c) => {
                if (map.palette[colorKey]) {
                    ctx.fillStyle = map.palette[colorKey];
                    ctx.fillRect(x + c * size, y + r * size, size, size);
                }
            });
        });
    },

    characters: {
        // Cello (Boy Character) Sprite Maps
        cello: {
            palette: { S: '#f2a66e', s: '#d88c57', H: '#3a2d27', T: '#4a90e2', t: '#3b73b5', P: '#333', p: '#222'},
            run1: [ ' HHH ', ' SSH ', 'SSTT ', ' TTt ', ' P p ' ],
            run2: [ ' HHH ', ' SSH ', 'SSTT ', ' T Tt', ' p P ' ],
            jump: [ ' HHH ', ' SSH ', 'SSTT ', ' TTT ', ' p p ' ]
        },
        // Fina (Girl Character) Sprite Maps
        fina: {
            palette: { S: '#ffbe87', s: '#e5a36f', H: '#8b572a', h: '#653f1f', D: '#e91e63', d: '#c2185b' },
            run1: [ ' HHHh', 'hSS H', ' SSDD', ' D dD', ' d d' ],
            run2: [ ' HHHh', 'hSS H', ' SSDD', ' D DD', 'd  d' ],
            jump: [ ' HHHh', 'hSS H', ' SSDD', ' dDd ', ' d d ' ]
        },
        // Placeholder sprites for teen/adult
        teen: { ...this.fina },
        adult: { ...this.cello }
    },

    // A single function to draw the correct animated character
    drawAnimatedCharacter(ctx, charType, x, y, size, animState, frame) {
        const charData = this.characters[charType];
        if (!charData) return;

        let mapToDraw;
        if (animState === 'jump') {
            mapToDraw = charData.jump;
        } else { // Running animation
            mapToDraw = (frame % 40 < 20) ? charData.run1 : charData.run2;
        }
        
        const mapObject = { palette: charData.palette, pixels: mapToDraw.map(row => row.split('')) };
        this.drawFromMap(ctx, x, y, mapObject, size);
    }
};

// --- SIDE SCROLLER MINIGAME ---
const sideScroller = {
    // ... (rest of the side scroller object remains largely the same)
    canvas: document.getElementById('minigame-canvas'),
    ctx: null,
    active: false,
    gameInterval: null,
    // State
    score: 0, lives: 3, tokens: 0, goal: 10, frame: 0,
    // Game Objects
    player: { x: 50, y: 220, w: 20, h: 20, vy: 0, grounded: true },
    objects: [], // { type, x, y, w, h, sprite }
    backgroundLayers: [],

    init() {
        this.ctx = this.canvas.getContext('2d');
        document.getElementById('minigame-start-btn').onclick = () => this.start();
        document.addEventListener('keydown', e => {
            if ((e.code === 'Space' || e.key === 'ArrowUp') && this.active) this.jump();
        });
        this.canvas.addEventListener('click', () => { if(this.active) this.jump(); });
    },
    start() {
        this.active = true;
        this.lives = 3; this.score = 0; this.tokens = 0; this.frame = 0;
        this.player.y = 220; this.player.vy = 0; this.player.grounded = true;
        this.objects = [];
        this.backgroundLayers = [
            { speed: 0.2, y: 50, height: 50, color: '#add8e6', objects: [{x: 100, w: 50}, {x: 400, w: 80}] }, // Far clouds
            { speed: 0.5, y: 150, height: 100, color: '#228b22', objects: [{x: 50, w: 200}, {x: 500, w: 150}] }, // Hills
        ];
        if (this.gameInterval) clearInterval(this.gameInterval);
        this.gameInterval = setInterval(() => this.loop(), 1000 / 60);
        this.updateUI();
    },
    loop() {
        this.frame++;
        this.player.vy += 0.8; // Gravity
        this.player.y += this.player.vy;
        if (this.player.y >= this.canvas.height - 40 - this.player.h) {
            this.player.y = this.canvas.height - 40 - this.player.h;
            this.player.vy = 0;
            this.player.grounded = true;
        }

        if (this.frame % 120 === 0) { /* ... spawn logic ... */ }
        if (this.frame % 180 === 0) { /* ... spawn logic ... */ }

        this.objects.forEach((obj, i) => {
            obj.x -= 4; // Move object
            if (this.player.x < obj.x + obj.w && this.player.x + this.player.w > obj.x &&
                this.player.y < obj.y + obj.h && this.player.y + this.player.h > obj.y) {
                // ... collision logic ...
            }
        });
        this.objects = this.objects.filter(o => o.x > -50);
        this.score++;

        // --- Drawing ---
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.drawBackground();
        // this.drawObjects(); // Logic for drawing objects remains the same

        // NEW: Draw the animated character
        const animState = this.player.grounded ? 'run' : 'jump';
        pixelArt.drawAnimatedCharacter(this.ctx, game.character, this.player.x, this.player.y, 4, animState, this.frame);
        
        this.updateUI();
        if (this.lives <= 0 || this.tokens >= this.goal) this.endGame();
    },
    drawBackground() {
        // Parallax Layers
        this.backgroundLayers.forEach(layer => {
            this.ctx.fillStyle = layer.color;
            layer.objects.forEach(obj => {
                let objX = (obj.x - (this.frame * layer.speed)) % (this.canvas.width + obj.w);
                if (objX < -obj.w) objX += (this.canvas.width + obj.w);
                this.ctx.fillRect(objX, layer.y, obj.w, layer.height);
            });
        });
        this.ctx.fillStyle = '#556b2f';
        this.ctx.fillRect(0, this.canvas.height - 40, this.canvas.width, 40);
    },
    endGame(isReset = false) {
        this.active = false;
        clearInterval(this.gameInterval);
        if (isReset) return; // Don't draw game over message if it's a hard reset
        
        this.ctx.fillStyle = 'rgba(0,0,0,0.5)';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.fillStyle = 'white';
        this.ctx.font = `24px "${getComputedStyle(document.body).getPropertyValue('--font-header')}"`;
        this.ctx.textAlign = 'center';
        const message = this.tokens >= this.goal ? "You Win! Great job!" : "Game Over. Try Again!";
        this.ctx.fillText(message, this.canvas.width / 2, this.canvas.height / 2);
    },
    jump() {
        if (this.player.grounded) {
            this.player.vy = -16;
            this.player.grounded = false;
        }
    },
    updateUI() {
        document.getElementById('minigame-score').textContent = this.score;
        document.getElementById('minigame-tokens').textContent = `${this.tokens} / ${this.goal}`;
        document.getElementById('minigame-lives').textContent = '‚ù§Ô∏è'.repeat(this.lives) + 'üñ§'.repeat(3 - this.lives);
    }
};


// --- UI AND EVENT HANDLERS ---
function switchScreen(screenName) {
    elements.sortingScreen.classList.toggle('active', screenName === 'sorting');
    elements.minigameScreen.classList.toggle('active', screenName === 'minigame');
    game.activeScreen = screenName;
    if (sideScroller.active) {
        sideScroller.endGame(true); // End game on screen switch without message
    }
}

function updateUIFromState() {
    // Reset radio buttons
    document.getElementById(`char-${game.character}`).checked = true;
    document.getElementById(`diff-${game.difficulty}`).checked = true;
    
    // Reset labels and progress
    elements.levelLabel.textContent = game.level;
    elements.scoreLabel.textContent = game.score;
    elements.streakLabel.textContent = game.streak;
    elements.timerLabel.textContent = '--:--';
    elements.progressFill.style.width = '0%';
}

function resetAndGoHome() {
    // Stop any active games
    if (sideScroller.active) {
        sideScroller.endGame(true);
    }
    if (game.timerId) {
        clearInterval(game.timerId);
    }
    
    // Reset game state
    game = { ...initialGameState };
    
    // Update UI to reflect reset state
    updateUIFromState();
    
    // Go to the main screen
    switchScreen('sorting');
}


document.getElementById('switch-to-minigame-btn').onclick = () => switchScreen('minigame');
document.getElementById('switch-to-sorting-btn').onclick = () => switchScreen('sorting');
document.getElementById('home-reset-btn').onclick = resetAndGoHome;

elements.characterSelector.onchange = (e) => { game.character = e.target.value; resetAndGoHome(); };
elements.difficultySelector.onchange = (e) => { game.difficulty = e.target.value; resetAndGoHome(); };

// --- INITIALIZE ---
window.onload = () => {
    sideScroller.init();
    updateUIFromState(); // Set initial UI
};
</script>
</body>
</html>

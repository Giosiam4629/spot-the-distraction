<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plagues Platformer</title>
  <style>
    :root{
      --ui:#050913; --card:#1f2937; --edge:#fff3; --txt:#e5e7eb;
      --pri:#22c55e; --sec:#60a5fa; --acc:#f472b6; --gold:#f59e0b;
    }
    body{margin:0;background:var(--ui);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    #wrap{display:grid;place-items:center;min-height:100vh;padding:16px}
    canvas{background:#0a0f1c;width:min(100vw,1100px);aspect-ratio:16/9;border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.65)}
    .panel{position:absolute;inset:16px;display:flex;align-items:center;justify-content:center}
    .card{background:linear-gradient(180deg, rgba(31,41,55,.96), rgba(17,24,39,.98));border:1px solid var(--edge);border-radius:18px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.5);max-width:92vw}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;background:linear-gradient(180deg,#0ea5e9,#2563eb);color:#fff;padding:12px 16px;border:none;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(37,99,235,.35)}
    .btn.secondary{background:linear-gradient(180deg,#10b981,#059669)}
    .btn.ghost{background:transparent;border:1px solid #ffffff40}
    .btn:active{transform:translateY(1px)}
    .subtle{opacity:.85}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="1280" height="720"></canvas>

    <!-- MAIN MENU -->
    <div id="menu" class="panel">
      <div class="card">
        <h1>üêë Plagues Platformer</h1>
        <p class="subtle">Play as a young shepherd boy with a glowing staff. Run, jump, and swat hazards while learning verses from the New World Translation (wol.jw.org).</p>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnStart">Start Game</button>
          <button class="btn ghost" id="btnHow">How to Play</button>
        </div>
        <div style="margin-top:10px" class="subtle">Controls: ‚Üê/‚Üí move ¬∑ ‚ñ≤/Space jump ¬∑ <b>X staff</b> ¬∑ P pause ¬∑ R restart ¬∑ M menu</div>
      </div>
    </div>

    <!-- HOW TO -->
    <div id="how" class="panel" style="display:none">
      <div class="card">
        <h2>How to Play</h2>
        <p>Reach the far right of each level to finish. Use your <b>staff (X)</b> to bat away hail and gently disperse swarms. Collectible scrolls and completion screens open New World Translation verses on wol.jw.org.</p>
        <div class="row"><button class="btn ghost" id="btnBackHow">Back</button></div>
      </div>
    </div>

    <!-- LEVEL COMPLETE (VERSE) -->
    <div id="versePanel" class="panel" style="display:none">
      <div class="card">
        <h2 id="vpTitle">Level Complete</h2>
        <p id="vpBlurb" style="margin-top:4px"></p>
        <p style="margin:8px 0"><a id="vpLink" href="#" target="_blank" rel="noopener">Open verse in NWT ‚Üí</a></p>
        <div class="row">
          <button class="btn secondary" id="btnNext">Next Level</button>
          <button class="btn ghost" id="btnMenu">Main Menu</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ========= Core Setup =========
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  let keys = {};
  addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase())) e.preventDefault();});
  addEventListener('keyup',   e=>{ keys[e.key.toLowerCase()] = false;});
  const down = k=>!!keys[k];
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>Math.random()*(b-a)+a;

  // ========= Plague Data (NWT links) =========
  const PLAQUES=[
    {name:'Water to Blood', verse:'Exodus 7:17', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/7#v7:17', blurb:"Jehovah showed his power over the Nile. He is stronger than any ruler."},
    {name:'Frogs', verse:'Exodus 8:2', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/8#v8:2', blurb:"Frogs everywhere! Jehovah can use even small things to make a big point."},
    {name:'Gnats', verse:'Exodus 8:17', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/8#v8:17', blurb:"The magicians admitted: ‚ÄòThis is God‚Äôs finger.‚Äô Jehovah‚Äôs power is real."},
    {name:'Flies', verse:'Exodus 8:24', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/8#v8:24', blurb:"Swarms filled Egypt, but God protected his people. He can protect us too."},
    {name:'Livestock Disease', verse:'Exodus 9:3', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/9#v9:3', blurb:"Jehovah controls life and health‚ÄîPharaoh was not in charge."},
    {name:'Boils', verse:'Exodus 9:10', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/9#v9:10', blurb:"Even the mighty Egyptians couldn‚Äôt stand against Jehovah."},
    {name:'Hail', verse:'Exodus 9:23', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/9#v9:23', blurb:"Hail like never before‚ÄîJehovah can use the weather to act."},
    {name:'Locusts', verse:'Exodus 10:13', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/10#v10:13', blurb:"Locusts cleared the fields‚ÄîJehovah‚Äôs warnings were serious."},
    {name:'Darkness', verse:'Exodus 10:22', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/10#v10:22', blurb:"Deep darkness‚Äîbut Israel still had light. Jehovah cares for his people."},
    {name:'Passover Protection', verse:'Exodus 12:13', url:'https://wol.jw.org/en/wol/b/r1/lp-e/nwt/study/Ex/12#v12:13', blurb:"Jehovah saw the blood and passed over‚Äîhe remembers obedient ones."}
  ];

  // ========= Player =========
  class Shepherd{
    constructor(x,y){
      this.x=x;this.y=y;this.vx=0;this.vy=0;this.g=1700;this.w=48;this.h=64;this.face=1;this.onGround=false;
      this.state='idle';this.animT=0;this.squash=1;this.justLanded=false;this.staffT=0;this.staffCD=0;
    }
    update(dt){
      const base=260, jumpV=660;
      if(down('arrowleft')||down('a')){this.vx=-base;this.face=-1}else if(down('arrowright')||down('d')){this.vx=base;this.face=1}else this.vx=0;
      if((down('arrowup')||down(' ')||down('w')) && this.onGround){this.vy=-jumpV;this.onGround=false; this.squash=0.88; this.justLanded=false; spawnDust(this.x+this.w/2,this.y+this.h);} 
      if(down('x') && this.staffCD<=0){ this.staffT=0.18; this.staffCD=0.32; spawnSpark(this.frontX(), this.y+this.h*0.3); }
      if(this.staffCD>0) this.staffCD-=dt; if(this.staffT>0) this.staffT-=dt;

      this.vy+=this.g*dt; if(this.vy>900) this.vy=900;
      const prevY=this.y, prevVy=this.vy;
      this.x+=this.vx*dt; this.y+=this.vy*dt;
      // ground
      if(this.y+this.h>H-80){ this.y=H-80-this.h; this.vy=0; if(!this.onGround && prevVy>240){ this.justLanded=true; spawnDust(this.x+this.w/2,this.y+this.h);} this.onGround=true; } else this.onGround=false;

      // squash & stretch
      if(this.justLanded){ this.squash = 1.15; this.justLanded=false; }
      const target = (!this.onGround) ? clamp(1+(-this.vy/900)*0.15,0.9,1.18) : 1;
      this.squash += (target - this.squash)*8*dt;

      // state
      const sp=Math.abs(this.vx);
      if(!this.onGround) this.state='air'; else if(sp>380) this.state='run'; else if(sp>40) this.state='walk'; else this.state='idle';
      this.animT += dt*(this.state==='run'? 8 : this.state==='walk'? 4 : 2);
    }
    frontX(){ return this.x + (this.face>0? this.w+8 : -8); }
    draw(){
      const {x,y,w,h}=this; const t=this.animT;
      ctx.save(); ctx.translate(x - camX + w/2, y + h/2); ctx.scale(this.face, this.squash);
      // shadow
      ctx.globalAlpha=.28; ctx.beginPath(); ctx.ellipse(0,h/2+10,18,6,0,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill(); ctx.globalAlpha=1;
      // motion params
      const swing=(this.state==='run'||this.state==='walk')? Math.sin(t)*(this.state==='run'?12:6):0;
      const leg=(this.state==='run'||this.state==='walk')? Math.cos(t)*(this.state==='run'?8:4):0;
      // tunic body
      roundRect(-w/2+6,-h/2+6,w-12,h-16,12,'#fbd38d','#00000055');
      // belt
      ctx.fillStyle='#8b5a2b'; ctx.fillRect(-12,6,24,4);
      // head & hair
      roundRect(-16,-h/2-18,32,28,12,'#ffe3b3'); dot(-6,-h/2-6,3.6,'#111827'); dot(6,-h/2-6,3.6,'#111827'); roundRect(-18,-h/2-24,36,12,6,'#6b4f37');
      // arms
      drawLimb(-14,-6,8,22,swing); drawLimb(14,-6,8,22,-swing);
      // legs
      drawLeg(-10,h/2-20,10,24,leg); drawLeg(10,h/2-20,10,24,-leg);
      // glowing staff + swing flash
      roundRect(w/2-10,-h/2-10,6,h+20,3,'#facc15');
      if(this.staffT>0){ ctx.globalAlpha=.35; ctx.beginPath(); ctx.arc(w/2+8,0,36, -0.8, 0.8); ctx.strokeStyle='#fde68a'; ctx.lineWidth=8; ctx.stroke(); ctx.globalAlpha=1; }
      ctx.restore();
    }
  }

  // ========= Hazards =========
  const hazards=[]; // {type:'hail'|'swarm', x,y,vx,vy,alive:boolean, batted:boolean}
  function spawnHail(){
    const x = camX + W + rand(0,300); const y = -40; hazards.push({type:'hail',x,y,vx:rand(-40,40),vy:rand(120,200),alive:true,batted:false});
  }
  function spawnSwarm(){
    const x = camX + W + 40; const y = rand(140,H-220); hazards.push({type:'swarm',x,y,vx:rand(-80,-40),vy:rand(-10,10),alive:true,batted:false, t:rand(0,6)});
  }
  function updateHazards(dt){
    for(const h of hazards){ if(!h.alive) continue; if(h.type==='hail'){ h.vy+=800*dt; h.x+=h.vx*dt; h.y+=h.vy*dt; if(h.y>H+60) h.alive=false; }
      if(h.type==='swarm'){ h.t+=dt; h.y += Math.sin(h.t*3)*22*dt; h.x += h.vx*dt; if(h.x < camX-60) h.alive=false; }
      // staff interaction
      if(player.staffT>0){ const fx=player.frontX(); const fy=player.y+player.h*0.3; const dx=h.x - fx; const dy=h.y - fy; const d=Math.hypot(dx,dy);
        if(d<64){ if(h.type==='hail'){ h.batted=true; h.vx = 340*player.face; h.vy = -260; spawnSpark(h.x,h.y); } else if(h.type==='swarm'){ h.alive=false; spawnSpark(h.x,h.y); } }
      }
      // player collision (soft bump)
      if(rectOverlap(player.x,player.y,player.w,player.h, h.x-12,h.y-12,24,24)){
        if(h.type==='hail' && !h.batted){ player.x -= 18*player.face; spawnDust(player.x+player.w/2, player.y+player.h); }
        if(h.type==='swarm'){ player.x -= 10*player.face; }
      }
    }
    // prune
    for(let i=hazards.length-1;i>=0;i--) if(!hazards[i].alive) hazards.splice(i,1);
  }
  function drawHazards(){
    for(const h of hazards){ ctx.save(); ctx.translate(h.x - camX, h.y);
      if(h.type==='hail') { ctx.fillStyle=h.batted?'#fef3c7':'#e5e7eb'; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#ffffff66'; ctx.beginPath(); ctx.moveTo(-12,-12); ctx.lineTo(12,12); ctx.stroke(); }
      if(h.type==='swarm'){ ctx.fillStyle='rgba(34,197,94,.9)'; for(let k=0;k<4;k++){ ctx.beginPath(); ctx.arc(Math.cos(h.t*6+k)*4, Math.sin(h.t*6+k)*4, 2, 0, Math.PI*2); ctx.fill(); } }
      ctx.restore(); }
  }

  // ========= FX =========
  let effects=[];
  function spawnDust(x,y){ effects.push({kind:'dust',x,y,t:0}); }
  function spawnSpark(x,y){ effects.push({kind:'spark',x,y,t:0}); }
  function drawFX(dt){ effects = effects.filter(e=>{ e.t+=dt; if(e.kind==='dust'){ const r=6+e.t*26, a=Math.max(0,.4-e.t*.35); ctx.save(); ctx.globalAlpha=a; ctx.strokeStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(e.x - camX, e.y, r, 0, Math.PI*2); ctx.stroke(); ctx.restore(); return e.t<1; } if(e.kind==='spark'){ const a=1-e.t; if(a<=0) return false; dot(e.x - camX, e.y, 3+e.t*18, `rgba(250,204,21,${a})`); return true; } return false; }); }

  // ========= World & Camera =========
  let levelIndex=0, camX=0, levelLen=2400; let player = new Shepherd(80,H-220);
  function resetLevel(i){ levelIndex=i; player=new Shepherd(80,H-220); camX=0; levelLen=2400; hazards.length=0; }
  function nextLevel(){ resetLevel((levelIndex+1)%PLAQUES.length); hide(versePanel); }
  function updateCamera(){ const target=clamp(player.x - W*0.4, 0, Math.max(0, levelLen-W)); camX += (target-camX)*0.08; }

  // ========= Backgrounds =========
  function bgNileBlood(){ let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#3b0d0d'); g.addColorStop(1,'#8b1a1a'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); // ground band
    ctx.fillStyle='#33140a'; ctx.fillRect(0,H-80,W,80); // pyramids
    drawPyramid(220,H-80,120,'#eab308','#d97706'); drawPyramid(620,H-80,140,'#eab308','#b45309'); // palms
    drawPalm(140,H-80); drawPalm(760,H-80);
  }
  function bgFrogs(){ let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#052316'); g.addColorStop(1,'#0b3a1a'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); // river
    const rg=ctx.createLinearGradient(0,H-160,0,H); rg.addColorStop(0,'#60a5fa'); rg.addColorStop(1,'#1e3a8a'); ctx.fillStyle=rg; ctx.fillRect(0,H-160,W,160); // reeds
    ctx.strokeStyle='#065f46'; for(let i=0;i<40;i++){ const x=(i*60 - (camX*.25)%60); ctx.beginPath(); ctx.moveTo(x,H-160); ctx.lineTo(x+rand(-6,6), H-210+rand(0,20)); ctx.stroke(); }
    // big lily pads in water (background)
    drawLily(W*0.2,H-90,60); drawLily(W*0.55,H-80,70); drawLily(W*0.8,H-100,60);
  }
  function bgDefault(){ let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0b1630'); g.addColorStop(1,'#16294e'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }

  function drawBackground(){ if(levelIndex===0) bgNileBlood(); else if(levelIndex===1) bgFrogs(); else if(levelIndex===6) { // hail sky
      let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#091426'); g.addColorStop(1,'#0f2747'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); } else bgDefault(); }

  // ========= Level Flow =========
  function tick(dt){ player.update(dt); updateCamera();
    // spawn hazards by level
    if(levelIndex===6){ if(Math.random()<0.08) spawnHail(); } // Hail
    if(levelIndex===2 || levelIndex===3){ if(Math.random()<0.04) spawnSwarm(); } // Gnats & Flies
    updateHazards(dt);
    // finish condition
    if(player.x > levelLen-120){ showLevelComplete(); }
  }
  function render(dt){ drawBackground(); drawGround(); drawParallaxBlobs(); drawHazards(); drawPlayer(); drawFX(dt); drawHUD(); }

  function drawGround(){ ctx.fillStyle='#111827'; ctx.fillRect(0,H-80,W,80); }
  function drawParallaxBlobs(){ ctx.globalAlpha=.22; for(let i=0;i<7;i++){ const y=H-240 + Math.sin(i+time*.3)*18; roundRect((i*280 - (camX*.3)%280)-200,y,480,180,40,'#a7f3d0'); } ctx.globalAlpha=1; }
  function drawPlayer(){ player.draw(); }
  function drawHUD(){ ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillRect(0,0,W,44); ctx.fillStyle='#fff'; ctx.font='16px system-ui'; ctx.fillText(`Level ${levelIndex+1} ‚Äî ${PLAQUES[levelIndex].name}`, 16, 26); ctx.textAlign='right'; ctx.fillText('X: staff  ¬∑  P: pause  ¬∑  R: restart  ¬∑  M: menu', W-16, 26); ctx.textAlign='left'; }

  function showLevelComplete(){ pause=true; show(versePanel); document.getElementById('vpTitle').textContent=`Level ${levelIndex+1} ‚Äî ${PLAQUES[levelIndex].name}`; document.getElementById('vpBlurb').textContent=PLAQUES[levelIndex].blurb + `  (Verse: ${PLAQUES[levelIndex].verse})`; const a=document.getElementById('vpLink'); a.href=PLAQUES[levelIndex].url; }

  // ========= UI Helpers =========
  const menu=document.getElementById('menu'); const how=document.getElementById('how'); const versePanel=document.getElementById('versePanel');
  function show(el){ [menu,how,versePanel].forEach(e=>e.style.display='none'); el.style.display='flex'; }
  function hide(el){ el.style.display='none'; }

  document.getElementById('btnStart').onclick=()=>{ hide(menu); pause=false; resetLevel(0); };
  document.getElementById('btnHow').onclick=()=>show(how);
  document.getElementById('btnBackHow').onclick=()=>show(menu);
  document.getElementById('btnNext').onclick=()=>{ nextLevel(); pause=false; };
  document.getElementById('btnMenu').onclick=()=>{ show(menu); pause=true; };

  addEventListener('keydown', e=>{
    const k=e.key.toLowerCase(); if(k==='p'){ pause=!pause; }
    if(k==='r'){ resetLevel(levelIndex); }
    if(k==='m'){ show(menu); pause=true; }
  });

  // ========= Loop =========
  let time=0, last=performance.now()/1000, pause=true;
  function loop(){ const now=performance.now()/1000, dt=clamp(now-last,0,1/30); last=now; if(!pause){ time+=dt; tick(dt); } render(dt); requestAnimationFrame(loop);} loop();

  // ========= Drawing Helpers =========
  function roundRect(x,y,w,h,r,fill,stroke){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill){ctx.fillStyle=fill; ctx.fill();} if(stroke){ctx.strokeStyle=stroke; ctx.stroke();} }
  function dot(x,y,r,c){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); if(typeof c==='string') ctx.fillStyle=c; ctx.fill(); }
  function drawLimb(x,y,w,h,angle){ ctx.save(); ctx.translate(x,y); ctx.rotate(angle*0.06); roundRect(-w/2,0,w,h,6,'#ffe3b3'); ctx.restore(); }
  function drawLeg(x,y,w,h,offset){ ctx.save(); ctx.translate(x+offset*0.2,y); roundRect(-w/2,0,w,h,6,'#ffe3b3'); roundRect(-w/2,h-6,w,8,4,'#8b5a2b'); ctx.restore(); }
  function drawPyramid(bx,by,base,light,shade){ const h=base*0.7; ctx.fillStyle=light; ctx.beginPath(); ctx.moveTo(bx,by); ctx.lineTo(bx+base,by); ctx.lineTo(bx+base*0.5,by-h); ctx.closePath(); ctx.fill(); ctx.fillStyle=shade; ctx.beginPath(); ctx.moveTo(bx+base*0.5,by-h); ctx.lineTo(bx+base,by); ctx.lineTo(bx+base*0.7,by-h*0.55); ctx.closePath(); ctx.fill(); }
  function drawPalm(xBase,groundY){ ctx.fillStyle='#065f46'; ctx.fillRect(xBase,groundY-70,10,70); ctx.beginPath(); ctx.moveTo(xBase+5,groundY-70); ctx.quadraticCurveTo(xBase-36,groundY-110,xBase-6,groundY-84); ctx.quadraticCurveTo(xBase+36,groundY-110,xBase+16,groundY-84); ctx.fillStyle='#10b981'; ctx.fill(); }
  function drawLily(cx,cy,r){ const g=ctx.createRadialGradient(cx,cy,r*0.2,cx,cy,r); g.addColorStop(0,'#4ade80'); g.addColorStop(1,'#166534'); ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,Math.PI*0.15,Math.PI*1.85); ctx.closePath(); ctx.fill(); ctx.fillStyle='rgba(255,255,255,.25)'; ctx.beginPath(); ctx.arc(cx-r*0.3,cy-r*0.3,r*0.35,0,Math.PI*2); ctx.fill(); }

  </script>
</body>
</html>
